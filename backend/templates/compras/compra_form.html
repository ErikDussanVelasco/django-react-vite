{% extends "inventario/base.html" %}
{% block title %}Nueva Compra{% endblock %}
{% block page_title %}Registrar Nueva Compra{% endblock %}

{% block content %}

<form id="compra-form" method="post" class="bg-white p-6 rounded-xl shadow max-w-4xl mx-auto">
    {% csrf_token %}

    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="p-4 rounded-lg bg-red-100 text-red-700">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div id="form-errors" class="mb-4" style="display:none;"></div>

    <div class="mb-6">
        <label class="block font-semibold mb-2">Proveedor</label>
        <select name="proveedor" required class="w-full p-2 border rounded bg-gray-50">
            <option value="">Selecciona un proveedor</option>
            {% for proveedor in proveedores %}
                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-6">
        <h3 class="font-semibold mb-3">Productos</h3>
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-gray-100 border-b">
                    <th class="px-4 py-2 text-left">Producto</th>
                    <th class="px-4 py-2 text-center">Cantidad</th>
                    <th class="px-4 py-2 text-right">Precio Unitario</th>
                    <th class="px-4 py-2 text-right">Subtotal</th>
                    <th class="px-4 py-2 text-center">Acción</th>
                </tr>
            </thead>

            <tbody id="productos-table">
            {% for producto in productos %}
                <tr class="border-b producto-row">
                    <td class="px-4 py-2 font-semibold">
                        <input type="hidden" name="producto_id[]" value="{{ producto.id }}">
                        <input type="hidden" name="producto_codigo[]" value="{{ producto.codigo }}">
                        <input type="hidden" name="producto_nombre[]" value="{{ producto.nombre }}">
                        {{ producto.nombre }} (Cod: {{ producto.codigo }})
                    </td>

                    <td class="px-4 py-2">
                        <input type="number" name="cantidad[]" min="0" step="1"
                               class="w-20 px-2 py-1 border rounded cantidad" placeholder="" value="">
                    </td>

                    <td class="px-4 py-2 text-right">
                        <input type="number" name="precio_unitario[]" value="{{ producto.precio_compra }}"
                               step="0.01" min="0" class="w-24 px-2 py-1 border rounded precio">
                    </td>

                    <td class="px-4 py-2 text-right font-semibold subtotal">$0.00</td>
                </tr>
            {% endfor %}
            </tbody>

        </table>
    </div>

    <div class="mb-6 text-right">
        <p class="text-xl font-bold text-gray-800">
            Total: <span class="text-green-700" id="total-general">$0.00</span>
        </p>
    </div>

    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold w-full">
        ✅ Registrar Compra
    </button>
</form>

<div class="max-w-4xl mx-auto mt-4">
    <button id="agregar-nuevo" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">➕ Agregar producto nuevo</button>
</div>

<script>
function actualizarTotales() {
    let totalGeneral = 0;

    document.querySelectorAll('.producto-row').forEach(row => {
        const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
        const precio = parseFloat(row.querySelector('.precio').value) || 0;
        const subtotal = cantidad * precio;

        row.querySelector('.subtotal').textContent = '$' + subtotal.toFixed(2);
        totalGeneral += subtotal;
    });

    document.getElementById('total-general').textContent = '$' + totalGeneral.toFixed(2);
}

document.addEventListener('input', function (e) {
    if (e.target.classList.contains('cantidad')) {
        actualizarTotales();
    }
});

// BORRAR FILA
document.addEventListener('click', function (e) {
    if (e.target.classList.contains('borrar')) {
        e.target.closest('tr').remove();
        actualizarTotales();
    }
});

// Agregar fila para producto nuevo (sin producto_id)
document.getElementById('agregar-nuevo').addEventListener('click', function (e) {
    e.preventDefault();
    const tbody = document.getElementById('productos-table');
    const tr = document.createElement('tr');
    tr.className = 'border-b producto-row';
    tr.innerHTML = `
        <td class="px-4 py-2 font-semibold">
            <input type="hidden" name="producto_id[]" value="">
            <div class="flex space-x-2">
                <input type="text" name="producto_codigo[]" placeholder="Código" class="px-2 py-1 border rounded w-28" required>
                <input type="text" name="producto_nombre[]" placeholder="Nombre del producto" class="px-2 py-1 border rounded w-64" required>
            </div>
        </td>
        <td class="px-4 py-2">
            <input type="number" name="cantidad[]" min="0" step="1" class="w-20 px-2 py-1 border rounded cantidad" placeholder="0" value="1">
        </td>
        <td class="px-4 py-2 text-right">
            <input type="number" name="precio_unitario[]" value="0.00" step="0.01" min="0" class="w-24 px-2 py-1 border rounded precio">
        </td>
        <td class="px-4 py-2 text-right font-semibold subtotal">$0.00</td>
        <td class="px-4 py-2 text-center"><button class="borrar text-red-600">✖</button></td>
    `;
    tbody.appendChild(tr);
});

// iniciar
document.addEventListener('DOMContentLoaded', actualizarTotales);

// Validación en el submit: codigo, nombre, cantidad y precio
document.getElementById('compra-form').addEventListener('submit', function (e) {
    const errores = [];
    let itemsValidos = 0;

    document.querySelectorAll('.producto-row').forEach((row, idx) => {
        const prodIdInput = row.querySelector('input[name="producto_id[]"]');
        const prodId = prodIdInput ? prodIdInput.value.trim() : '';

        const qtyInput = row.querySelector('input[name="cantidad[]"]');
        const qty = qtyInput ? parseInt(qtyInput.value) || 0 : 0;

        const priceInput = row.querySelector('input[name="precio_unitario[]"]');
        const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;

        // New product (no prodId) -> require codigo, nombre, cantidad>0, precio>0
        if (!prodId) {
            const codigoInput = row.querySelector('input[name="producto_codigo[]"]');
            const nombreInput = row.querySelector('input[name="producto_nombre[]"]');
            const codigo = codigoInput ? codigoInput.value.trim() : '';
            const nombre = nombreInput ? nombreInput.value.trim() : '';

            // If the row is completely empty (no codigo, no nombre, no qty), skip it
            if (!codigo && !nombre && qty === 0) {
                return; // continue
            }

            // Otherwise validate required fields
            if (!codigo) {
                errores.push(`Fila ${idx + 1}: Código es obligatorio para productos nuevos.`);
            } else if (!/^\d+$/.test(codigo)) {
                errores.push(`Fila ${idx + 1}: Código debe ser numérico.`);
            }

            if (!nombre) {
                errores.push(`Fila ${idx + 1}: Nombre es obligatorio para productos nuevos.`);
            }

            if (qty <= 0) {
                errores.push(`Fila ${idx + 1}: Cantidad debe ser mayor que 0.`);
            }

            if (price <= 0) {
                errores.push(`Fila ${idx + 1}: Precio unitario debe ser mayor que 0.`);
            }

            if (codigo && nombre && qty > 0 && price > 0) itemsValidos += 1;

        } else {
            // Existing product: if cantidad > 0 require precio > 0
            if (qty > 0) {
                if (price <= 0) {
                    errores.push(`Fila ${idx + 1}: Precio unitario debe ser mayor que 0 para productos existentes con cantidad.`);
                } else {
                    itemsValidos += 1;
                }
            }
        }
    });

    if (itemsValidos === 0) {
        errores.push('Debes agregar al menos un producto con cantidad y precio válidos.');
    }

    const erroresDiv = document.getElementById('form-errors');
    if (errores.length) {
        e.preventDefault();
        erroresDiv.style.display = 'block';
        erroresDiv.className = 'mb-4 p-3 rounded bg-red-100 text-red-700';
        erroresDiv.innerHTML = '<ul class="list-disc pl-5">' + errores.map(x => `<li>${x}</li>`).join('') + '</ul>';
        window.scrollTo({ top: erroresDiv.offsetTop - 20, behavior: 'smooth' });
    } else {
        // allow submit
    }
});
</script>

{% endblock %}
